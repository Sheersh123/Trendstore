pipeline {
  agent any

  environment {
    DOCKERHUB_CREDS = 'dockerhub-creds'
    DOCKERHUB_USER  = 'sheershsinha'
    IMAGE_NAME      = 'sheershsinha/trendstore:v1'
    IMAGE           = "${DOCKERHUB_USER}/${IMAGE_NAME}"  // Secret file credential
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Build & Push Image') {
      steps {
        script {
          def dockerImage = docker.build("${IMAGE}:${env.BUILD_NUMBER}")

          docker.withRegistry('', DOCKERHUB_CREDS) {
            dockerImage.push("${env.BUILD_NUMBER}")
            dockerImage.push("latest")
          }
        }
      }
    }
  }

  post {
    always {
      sh 'docker system prune -af || true'
    }
  }
}
