pipeline {
  agent any

  environment {
    // Docker
    IMAGE       = "sheershsinha/trendstore"
    TAG         = "v1"

    // EKS
    AWS_REGION  = "us-east-2"
    CLUSTER_NAME = "Trendstore-eks"
  }

  stages {

    stage('Checkout Code') {
      steps {
        git branch: 'main', url: 'https://github.com/Sheersh123/Trendstore.git'
      }
    }

    stage('Build Docker Image') {
      steps {
        sh '''
          docker build -t $IMAGE:$TAG .
        '''
      }
    }

    stage('Login to DockerHub & Push') {
      steps {
        withCredentials([
          usernamePassword(
            credentialsId: 'Token-02',   // Jenkins Credential ID (must match exactly)
            usernameVariable: 'DOCKER_USER',
            passwordVariable: 'DOCKER_PASS'
          )
        ]) {
          sh '''
            echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
            docker push $IMAGE:$TAG
            docker tag  $IMAGE:$TAG $IMAGE:latest
            docker push $IMAGE:latest
          '''
        }
      }
    }

    stage('Update kubeconfig for EKS') {
      steps {
        // Requires AWS CLI configured + permissions to describe the cluster
        sh '''
          echo "AWS_REGION=$AWS_REGION"
          echo "CLUSTER_NAME=$CLUSTER_NAME"
          aws eks update-kubeconfig --region $AWS_REGION --name $CLUSTER_NAME
        '''
      }
    }

    stage('Deploy to EKS via kubectl') {
      steps {
        dir {'Kubernetes'}
        sh '''
          ls -la
          kubectl apply -f deployment.yaml
          kubectl apply -f service.yaml

          echo "Waiting for rollout..."
          kubectl rollout status deployment/trendstore-deployment
        '''
      }
    }
  }

  post {
    always {
      sh 'docker system prune -af || true'
    }
  }
}
